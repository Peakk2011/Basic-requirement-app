<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <title>3D World Clock & City Status App</title>
    <style>
        /* --- ตั้งค่าสไตล์สำหรับ Canvas และ UI Overlay --- */
        body,
        html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
            font-family: Arial, sans-serif;
        }

        #container {
            width: 100%;
            height: 100%;
        }

        /* ปุ่มอยู่ที่มุมบนซ้าย */
        #uiOverlay {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
        }

        /* Panel แสดง Card ของเมืองที่บันทึกไว้ */
        #cardsContainer {
            position: absolute;
            bottom: 10px;
            left: 10px;
            max-height: 40%;
            overflow-y: auto;
            width: 300px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            z-index: 10;
        }

        #cardsContainer h3 {
            margin-top: 0;
        }

        .card {
            background: #fff;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }

        /* สไตล์ Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 300px;
            border-radius: 5px;
            text-align: center;
        }

        .close {
            float: right;
            cursor: pointer;
            font-size: 22px;
        }

        input[type="text"] {
            width: 90%;
            padding: 5px;
            margin-top: 5px;
            margin-bottom: 10px;
        }

        button {
            cursor: pointer;
        }
    </style>
</head>

<body>
    <!-- Container สำหรับ 3D Canvas -->
    <div id="container"></div>

    <!-- UI Overlay สำหรับปุ่มเพิ่มเมือง -->
    <div id="uiOverlay">
        <button id="addCityBtn">เพิ่มเมือง</button>
    </div>

    <!-- Panel แสดง Card ของเมืองที่ถูกเพิ่มไว้ -->
    <div id="cardsContainer">
        <h3>เมืองที่เพิ่มไว้</h3>
        <div id="cityCards"></div>
    </div>

    <!-- Modal สำหรับเพิ่มรายละเอียดของเมือง -->
    <div id="cityModal" class="modal">
        <div class="modal-content">
            <span id="closeModal" class="close">&times;</span>
            <h3 id="modalTitle">เพิ่มเมือง</h3>
            <p id="modalCoords">พิกัด: </p>
            <p id="modalUTC">UTC Time: Loading...</p>
            <p id="modalLocalTime">Local Time: Loading...</p>
            <p id="modalTemp">Temperature: Loading...</p>
            <label>ชื่อเมือง:
                <input type="text" id="cityNameInput" placeholder="ระบุชื่อเมือง">
            </label>
            <br>
            <button id="saveCityModalBtn">บันทึกเมือง</button>
        </div>
    </div>

    <!-- โหลด Three.js และ OrbitControls -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/controls/OrbitControls.js"></script>
    <script>
        /* -------- กำหนด global variables สำหรับ Three.js -------- */
        let scene, camera, renderer, controls, globe;
        let raycaster, mouse;
        let selectedCoords = null; // เก็บพิกัดที่เลือกบนโลก
        const cityMarkers = [];    // เก็บ marker ของแต่ละเมือง

        // เริ่มต้น scene, camera, renderer และ globe 3D
        function init() {
            const container = document.getElementById('container');
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);

            // สร้างโลกด้วย Sphere Geometry พร้อม texture จากภาพโลก
            const sphereGeometry = new THREE.SphereGeometry(5, 32, 32);
            const textureLoader = new THREE.TextureLoader();
            const earthTexture = textureLoader.load('https://threejsfundamentals.org/threejs/resources/images/earth-day.jpg');
            const sphereMaterial = new THREE.MeshBasicMaterial({ map: earthTexture });
            globe = new THREE.Mesh(sphereGeometry, sphereMaterial);
            scene.add(globe);

            // แสงสว่าง
            const ambientLight = new THREE.AmbientLight(0xffffff, 1);
            scene.add(ambientLight);

            // ตั้งค่ากล้องและตำแหน่งเริ่มต้น
            camera.position.set(0, 0, 10);

            // OrbitControls สำหรับ pan/zoom/rotate
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enablePan = true;
            controls.enableZoom = true;
            controls.update();

            // raycaster สำหรับแปลงตำแหน่งคลิกไปเป็นจุดบนโลก
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            window.addEventListener('resize', onWindowResize, false);
            animate();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        init();

        /* -------- ส่วน Event สำหรับระบบเพิ่มเมือง -------- */
        const addCityBtn = document.getElementById('addCityBtn');
        addCityBtn.addEventListener('click', () => {
            alert('กรุณาคลิกบนโลกเพื่อเลือกตำแหน่งของเมือง');
            // ตั้ง listener ให้คลิกบน globe ครั้งถัดไป (once เพื่อให้ทำงานเพียงครั้งเดียว)
            renderer.domElement.addEventListener('click', onGlobeClick, { once: true });
        });

        function onGlobeClick(event) {
            // ค่าปกติของ mouse (Normalized device coordinates)
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObject(globe);

            if (intersects.length > 0) {
                const point = intersects[0].point;
                // แปลงตำแหน่งจุดบนทรงกลมเป็น spherical coordinates
                const spherical = new THREE.Spherical().setFromVector3(point);
                const lat = 90 - THREE.Math.radToDeg(spherical.phi);
                const lng = THREE.Math.radToDeg(spherical.theta) - 180;
                selectedCoords = { lat, lng };
                openCityModal(selectedCoords);
            } else {
                alert('ไม่พบตำแหน่งบนโลก กรุณาลองใหม่อีกครั้ง');
            }
        }

        /* -------- ระบบ Modal สำหรับเพิ่มรายละเอียดเมือง -------- */
        const cityModal = document.getElementById('cityModal');
        const closeModalEl = document.getElementById('closeModal');
        closeModalEl.onclick = function () {
            cityModal.style.display = "none";
        };

        function openCityModal(coords) {
            cityModal.style.display = "block";
            document.getElementById('modalCoords').textContent =
                `พิกัด: ละติจูด ${coords.lat.toFixed(2)}, ลองจิจูด ${coords.lng.toFixed(2)}`;
            document.getElementById('modalTitle').textContent = "เพิ่มเมือง";
            document.getElementById('cityNameInput').value = "";

            updateModalTimesAndTemp(coords);
        }

        // อัปเดตเวลาของเมืองใน Modal (UTC Time และ Local Time) พร้อมดึงอุณหภูมิ
        function updateModalTimesAndTemp(coords) {
            // คำนวณ offset แบบคร่าวจากลองจิจูด
            const offsetHours = Math.round(coords.lng / 15);

            const updateTimes = () => {
                const now = new Date();
                // เวลามาตรฐาน UTC
                const utcTime = now.toUTCString();
                // เวลาของเมืองโดยเพิ่ม offset (แบบคร่าว)
                let localTime = new Date(now.getTime() + offsetHours * 3600000);
                document.getElementById('modalUTC').textContent = `UTC Time: ${utcTime}`;
                document.getElementById('modalLocalTime').textContent = `Local Time: ${localTime.toLocaleTimeString()}`;
            };

            updateTimes();
            // อัปเดตกำหนดทุก 1 วินาที ถ้า Modal ยังเปิดอยู่
            let modalInterval = setInterval(() => {
                if (cityModal.style.display === "none") {
                    clearInterval(modalInterval);
                } else {
                    updateTimes();
                }
            }, 1000);

            // ดึงข้อมูลอุณหภูมิจาก OpenWeatherMap API
            fetchTemperature(coords.lat, coords.lng).then(temp => {
                document.getElementById('modalTemp').textContent = `Temperature: ${temp}°C`;
            }).catch(err => {
                document.getElementById('modalTemp').textContent = "Temperature: N/A";
            });
        }

        // เมื่อกดปุ่มบันทึกใน Modal
        const saveCityModalBtn = document.getElementById('saveCityModalBtn');
        saveCityModalBtn.addEventListener('click', () => {
            const cityName = document.getElementById('cityNameInput').value.trim();
            if (!cityName) {
                alert('กรุณาระบุชื่อเมือง');
                return;
            }
            const offsetHours = Math.round(selectedCoords.lng / 15);
            const city = {
                name: cityName,
                lat: selectedCoords.lat,
                lng: selectedCoords.lng,
                offsetHours: offsetHours
            };
            // บันทึกเมืองเข้า localStorage
            saveCity(city);
            // แสดง marker บนโลก
            addCityMarker(city);
            cityModal.style.display = "none";
        });

        /* -------- ระบบ localStorage สำหรับบันทึกเมือง -------- */
        function saveCity(city) {
            let savedCities = JSON.parse(localStorage.getItem('savedCities')) || [];
            savedCities.push(city);
            localStorage.setItem('savedCities', JSON.stringify(savedCities));
            addCityCard(city);
        }

        function loadSavedCities() {
            let savedCities = JSON.parse(localStorage.getItem('savedCities')) || [];
            savedCities.forEach(city => {
                addCityCard(city);
                addCityMarker(city);
            });
        }

        /* -------- สร้าง Card แสดงข้อมูลของเมือง -------- */
        function addCityCard(city) {
            const container = document.getElementById('cityCards');
            const card = document.createElement('div');
            card.classList.add('card');

            const title = document.createElement('h4');
            title.textContent = city.name;

            const coordsP = document.createElement('p');
            coordsP.textContent = `พิกัด: ละติจูด ${city.lat.toFixed(2)}, ลองจิจูด ${city.lng.toFixed(2)}`;

            const utcP = document.createElement('p');
            utcP.textContent = "UTC Time: Loading...";

            const localP = document.createElement('p');
            localP.textContent = "Local Time: Loading...";

            const tempP = document.createElement('p');
            tempP.textContent = "Temperature: Loading...";

            card.appendChild(title);
            card.appendChild(coordsP);
            card.appendChild(utcP);
            card.appendChild(localP);
            card.appendChild(tempP);

            document.getElementById('cityCards').appendChild(card);

            // อัปเดตเวลาทุกวินาที
            setInterval(() => {
                const now = new Date();
                utcP.textContent = `UTC Time: ${now.toUTCString()}`;
                let localTime = new Date(now.getTime() + city.offsetHours * 3600000);
                localP.textContent = `Local Time: ${localTime.toLocaleTimeString()}`;
            }, 1000);

            // ดึงอุณหภูมิสำหรับเมืองนี้
            fetchTemperature(city.lat, city.lng).then(temp => {
                tempP.textContent = `Temperature: ${temp}°C`;
            }).catch(err => {
                tempP.textContent = "Temperature: N/A";
            });
        }

        /* -------- เพิ่ม marker บน globe เพื่อแสดงตำแหน่งเมือง -------- */
        function addCityMarker(city) {
            // marker เป็น sphere ขนาดเล็ก สีแดง
            const markerGeometry = new THREE.SphereGeometry(0.1, 8, 8);
            const markerMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
            const marker = new THREE.Mesh(markerGeometry, markerMaterial);

            // แปลงพิกัดละติจูดและลองจิจูดให้อยู่บนพื้นผิวของทรงกลม (radius = 5)
            const phi = THREE.Math.degToRad(90 - city.lat);
            const theta = THREE.Math.degToRad(city.lng + 180);
            marker.position.x = 5 * Math.sin(phi) * Math.cos(theta);
            marker.position.y = 5 * Math.cos(phi);
            marker.position.z = 5 * Math.sin(phi) * Math.sin(theta);

            scene.add(marker);
            cityMarkers.push(marker);
        }

        /* -------- ฟังก์ชันดึงข้อมูลอุณหภูมิจาก OpenWeatherMap API -------- */
        async function fetchTemperature(lat, lng) {
            const apiKey = "YOUR_OPENWEATHERMAP_API_KEY"; // แทนที่ด้วย API Key ที่ใช้งานจริง
            const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&units=metric&appid=${apiKey}`;
            let response = await fetch(url);
            if (!response.ok) throw new Error("Error fetching temperature");
            let data = await response.json();
            return data.main.temp;
        }

        // โหลดเมืองที่บันทึกไว้เมื่อเริ่มต้นหน้าเว็บ
        loadSavedCities();
    </script>
</body>

</html>